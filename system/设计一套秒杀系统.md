title: 如何设计一个秒杀系统

---

## 需求

设计一个秒杀系统，支持百万级用户秒杀，不能超卖

## 业务处理流程

正常的一个业务处理流程

- 用户下单，生成订单
- 库存系统减库存

## 并发问题

### 前端限流

网关层直接过滤掉90%的请求

### 优化缓存

查询库存时使用缓存；
系统启动初始化时，同步数据库的库存到缓存；
下单后，数据库减少成功后，同步缓存；

### 优化数据库

- 通过数据库乐观锁防止超卖

update goods_table
set count = count - 1
where goods_id = xxxx & store > 0

### 优化内存程序

如果库存卖完了，在程序内存里写一个库存是否售完的标记
如果商品售完，不用请求缓存，直接返回商品已售完；

### 下单失败的情况

库存增加，先写数据库，再写缓存，再将商品售完标记置为false

## 测试

用jmeter或其他工具模拟并发，进行压测，保证系统质量
